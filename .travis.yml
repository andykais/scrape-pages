language: node_js

stages:
  - name: typecheck-test-lint
    if: branch = master OR type IN (pull_request)
  - name: deploy-npm
    if: tag IS present
  - name: deploy-website
    if: branch = master AND NOT type IN (pull_request)

cache:
  directories:
    - $HOME/.npm

jobs:
  include:
    - stage: typecheck-test-lint
      name: typecheck
      node_js: '8'
      script: npm run typecheck

    - stage: typecheck-test-lint
      name: test node:10
      node_js: '10'
      script: npm run test:unit && npm run test:functional
    - stage: typecheck-test-lint
      name: test node:9
      node_js: '9'
      script: npm run test:unit && npm run test:functional
    - stage: typecheck-test-lint
      name: test node:8
      node_js: '8'
      script: npm run test:unit && npm run test:functional

    - stage: typecheck-test-lint
      name: check formatting
      node_js: '8'
      script: npm run format:check

    - stage: deploy-npm
      node_js: '8'
      script: skip
      deploy:
        provider: script
        script: bash publish.sh
        skip_cleanup: true
        on:
          tags: true

    - stage: deploy-website
      node_js: '8'
      before_install: cd website
      script: npm run build
      deploy:
        provider: pages
        local-dir: website/dist
        skip-cleanup: true
        github-token: $GITHUB_TOKEN
        keep-history: true
